---
# generated by https://github.com/hashicorp/terraform-plugin-docs
page_title: "seqera_tower_agent_credential Resource - terraform-provider-seqera"
subcategory: ""
description: |-
  Manage Tower Agent credentials in Seqera platform using this resource.
  Tower Agent credentials store connection IDs for Tower Agent instances that
  enable secure communication between the Seqera Platform and compute environments.
---

# seqera_tower_agent_credential (Resource)

Manage Tower Agent credentials in Seqera platform using this resource.

Tower Agent credentials store connection IDs for Tower Agent instances that
enable secure communication between the Seqera Platform and compute environments.

## Example Usage

```terraform
# Seqera Tower Agent Credentials Examples
#
# Tower Agent credentials store connection IDs for Tower Agent instances that
# enable secure communication between the Seqera Platform and compute environments.
#
# SECURITY BEST PRACTICES:
# - Use unique connection IDs for each Tower Agent instance
# - Store connection IDs securely
# - Rotate connection IDs periodically
# - Monitor Tower Agent connectivity
# - Use separate agents for different environments

# Required provider for generating random UUIDs
terraform {
  required_providers {
    random = {
      source  = "hashicorp/random"
      version = "~> 3.6"
    }
    seqera = {
      source = "seqeralabs/seqera"
    }
  }
}

# =============================================================================
# Example 1: Basic Tower Agent Credentials with Random Connection ID
# =============================================================================
# Generate a random UUID for the Tower Agent connection ID

resource "random_uuid" "tower_agent_connection_id" {
  # Lifecycle meta-argument to prevent ID regeneration
  lifecycle {
    ignore_changes = all
  }
}

resource "seqera_tower_agent_credential" "basic" {
  name         = "tower-agent-main"
  workspace_id = seqera_workspace.main.id

  connection_id = random_uuid.tower_agent_connection_id.result
}

# Output the connection ID for use in Tower Agent deployment
output "tower_agent_connection_id" {
  description = "Connection ID for the Tower Agent instance"
  value       = random_uuid.tower_agent_connection_id.result
  sensitive   = true
}

# Output the credentials ID
output "tower_agent_credentials_id" {
  description = "Seqera credentials ID for the Tower Agent"
  value       = seqera_tower_agent_credential.basic.credentials_id
}

# =============================================================================
# Example 2: Tower Agent with Working Directory
# =============================================================================

resource "random_uuid" "tower_agent_with_workdir_id" {
  lifecycle {
    ignore_changes = all
  }
}

resource "seqera_tower_agent_credential" "with_workdir" {
  name         = "tower-agent-workdir"
  workspace_id = seqera_workspace.main.id

  connection_id = random_uuid.tower_agent_with_workdir_id.result
  work_dir      = "/work/tower-agent"
}

output "tower_agent_with_workdir_connection_id" {
  description = "Connection ID for Tower Agent with custom work directory"
  value       = random_uuid.tower_agent_with_workdir_id.result
  sensitive   = true
}

# =============================================================================
# Example 3: Multiple Tower Agent Credentials for Different Environments
# =============================================================================

locals {
  tower_agents = {
    "dev" = {
      work_dir = "/work/tower-agent-dev"
    }
    "staging" = {
      work_dir = "/work/tower-agent-staging"
    }
    "prod" = {
      work_dir = "/work/tower-agent-prod"
    }
  }
}

resource "random_uuid" "tower_agent_env_ids" {
  for_each = local.tower_agents

  lifecycle {
    ignore_changes = all
  }
}

resource "seqera_tower_agent_credential" "by_environment" {
  for_each = local.tower_agents

  name         = "tower-agent-${each.key}"
  workspace_id = seqera_workspace.main.id
  connection_id = random_uuid.tower_agent_env_ids[each.key].result
  work_dir     = each.value.work_dir
}

output "tower_agent_connection_ids_by_env" {
  description = "Map of environment names to Tower Agent connection IDs"
  value = {
    for env, agent in seqera_tower_agent_credential.by_environment :
    env => random_uuid.tower_agent_env_ids[env].result
  }
  sensitive = true
}

# =============================================================================
# Example 4: Tower Agent Deployment Command Generator
# =============================================================================
# Generate the deployment commands for Tower Agent instances

locals {
  tower_agent_url = "https://github.com/seqeralabs/tower-agent/releases/latest/download/tw-agent-linux-x86_64"
  seqera_api_url  = "https://cloud.seqera.io/api"
}

output "tower_agent_deployment_commands" {
  description = "Commands to deploy Tower Agent instances"
  value = {
    for env, agent in seqera_tower_agent_credential.by_environment :
    env => <<-EOT
      # Download and run Tower Agent for ${env}
      export TOWER_ACCESS_TOKEN=<YOUR_TOKEN>
      curl -fSL ${local.tower_agent_url} > tw-agent
      chmod +x tw-agent
      ./tw-agent ${random_uuid.tower_agent_env_ids[env].result} \\
        -u ${local.seqera_api_url} \\
        --work-dir=${each.value.work_dir}
    EOT
  }
  sensitive = true
}

# =============================================================================
# Example 5: Tower Agent for HPC Cluster
# =============================================================================

resource "random_uuid" "hpc_tower_agent_id" {
  lifecycle {
    ignore_changes = all
  }
}

resource "seqera_tower_agent_credential" "hpc_cluster" {
  name         = "tower-agent-hpc"
  workspace_id = seqera_workspace.main.id
  connection_id = random_uuid.hpc_tower_agent_id.result
  work_dir     = "/scratch/tower-agent"
}

output "hpc_tower_agent_info" {
  description = "Tower Agent information for HPC cluster"
  value = {
    connection_id  = random_uuid.hpc_tower_agent_id.result
    credentials_id = seqera_tower_agent_credential.hpc_cluster.credentials_id
    work_dir       = seqera_tower_agent_credential.hpc_cluster.work_dir
  }
  sensitive = true
}

# =============================================================================
# Example 6: Tower Agent with Kubernetes Deployment
# =============================================================================

resource "random_uuid" "k8s_tower_agent_id" {
  lifecycle {
    ignore_changes = all
  }
}

resource "seqera_tower_agent_credential" "kubernetes" {
  name         = "tower-agent-k8s"
  workspace_id = seqera_workspace.main.id
  connection_id = random_uuid.k8s_tower_agent_id.result
  work_dir     = "/work"
}

# Generate Kubernetes deployment manifest
output "kubernetes_deployment_manifest" {
  description = "Kubernetes deployment manifest for Tower Agent"
  value = yamlencode({
    apiVersion = "apps/v1"
    kind       = "Deployment"
    metadata = {
      name      = "tower-agent"
      namespace = "seqera"
    }
    spec = {
      replicas = 1
      selector = {
        matchLabels = {
          app = "tower-agent"
        }
      }
      template = {
        metadata = {
          labels = {
            app = "tower-agent"
          }
        }
        spec = {
          containers = [{
            name  = "tower-agent"
            image = "cr.seqera.io/public/tower-agent:latest"
            env = [
              {
                name  = "TOWER_AGENT_CONNECTION_ID"
                value = random_uuid.k8s_tower_agent_id.result
              },
              {
                name = "TOWER_ACCESS_TOKEN"
                valueFrom = {
                  secretKeyRef = {
                    name = "tower-agent-secret"
                    key  = "token"
                  }
                }
              },
              {
                name  = "TOWER_API_ENDPOINT"
                value = "https://cloud.seqera.io/api"
              }
            ]
            volumeMounts = [{
              name      = "work-dir"
              mountPath = "/work"
            }]
          }]
          volumes = [{
            name = "work-dir"
            emptyDir = {}
          }]
        }
      }
    }
  })
}

# =============================================================================
# Example 7: Tower Agent Connection ID Management
# =============================================================================
# Best practices for managing Tower Agent connection IDs

# Use ignore_changes to prevent connection ID regeneration
resource "random_uuid" "stable_agent_id" {
  lifecycle {
    ignore_changes = all
  }
}

resource "seqera_tower_agent_credential" "stable_agent" {
  name         = "tower-agent-stable"
  workspace_id = seqera_workspace.main.id
  connection_id = random_uuid.stable_agent_id.result

  # Prevent accidental deletion
  lifecycle {
    prevent_destroy = false # Set to true in production
  }
}

# =============================================================================
# Example 8: Tower Agent Deployment Script
# =============================================================================

resource "random_uuid" "script_agent_id" {
  lifecycle {
    ignore_changes = all
  }
}

resource "seqera_tower_agent_credential" "script_deploy" {
  name         = "tower-agent-script"
  workspace_id = seqera_workspace.main.id
  connection_id = random_uuid.script_agent_id.result
  work_dir     = "/opt/tower-agent/work"
}

# Create a local file with the deployment script
resource "local_file" "tower_agent_deploy_script" {
  filename = "${path.module}/deploy-tower-agent.sh"
  content  = <<-EOT
    #!/bin/bash
    set -e

    # Tower Agent Deployment Script
    AGENT_CONNECTION_ID="${random_uuid.script_agent_id.result}"
    TOWER_API_ENDPOINT="https://cloud.seqera.io/api"
    WORK_DIR="${seqera_tower_agent_credential.script_deploy.work_dir}"

    # Check if TOWER_ACCESS_TOKEN is set
    if [ -z "$TOWER_ACCESS_TOKEN" ]; then
      echo "Error: TOWER_ACCESS_TOKEN environment variable is not set"
      exit 1
    fi

    # Download Tower Agent
    echo "Downloading Tower Agent..."
    curl -fSL https://github.com/seqeralabs/tower-agent/releases/latest/download/tw-agent-linux-x86_64 > tw-agent
    chmod +x tw-agent

    # Create work directory
    mkdir -p "$WORK_DIR"

    # Run Tower Agent
    echo "Starting Tower Agent..."
    ./tw-agent "$AGENT_CONNECTION_ID" \
      -u "$TOWER_API_ENDPOINT" \
      --work-dir="$WORK_DIR"
  EOT

  file_permission = "0755"
}

output "deployment_script_path" {
  description = "Path to the Tower Agent deployment script"
  value       = local_file.tower_agent_deploy_script.filename
}

# =============================================================================
# Using Tower Agent Credentials
# =============================================================================
# After creating Tower Agent credentials:
#
# 1. Retrieve your access token from Seqera Platform
# 2. Deploy the Tower Agent on your compute environment
# 3. Use the connection ID from the output
# 4. The agent will establish a secure connection to Seqera Platform
#
# Example deployment command:
# export TOWER_ACCESS_TOKEN=<your-token>
# curl -fSL https://github.com/seqeralabs/tower-agent/releases/latest/download/tw-agent-linux-x86_64 > tw-agent
# chmod +x tw-agent
# ./tw-agent <CONNECTION_ID> -u https://cloud.seqera.io/api --work-dir=./work

# =============================================================================
# Tower Agent Features
# =============================================================================
# Tower Agent enables:
# - Secure connectivity to on-premises or air-gapped environments
# - No need to expose compute infrastructure to the internet
# - Support for HPC clusters, Kubernetes, and cloud environments
# - Centralized workflow management and monitoring
# - Real-time job status updates

# =============================================================================
# SECURITY RECOMMENDATIONS
# =============================================================================
#
# 1. Use unique connection IDs for each Tower Agent instance
# 2. Store connection IDs securely (use sensitive = true on outputs)
# 3. Use lifecycle.ignore_changes on random_uuid to prevent ID regeneration
# 4. Rotate connection IDs periodically by creating new credentials
# 5. Monitor Tower Agent connectivity and logs
# 6. Use separate agents for different environments
# 7. Implement proper access controls for Tower Agent deployment
# 8. Use secure channels for distributing connection IDs
# 9. Audit Tower Agent usage regularly
# 10. Use work_dir on isolated storage with appropriate permissions
```

<!-- schema generated by tfplugindocs -->
## Schema

### Required

- `connection_id` (String) Tower Agent connection ID (required). A unique UUID string used to identify the Tower Agent instance. Generate using random_uuid resource.
- `name` (String) Display name for the credential (max 100 characters). Requires replacement if changed.

### Optional

- `work_dir` (String) Working directory for the Tower Agent (optional)
- `workspace_id` (Number) Workspace numeric identifier

### Read-Only

- `credentials_id` (String) Credentials string identifier
- `id` (String) Unique identifier for the credential (max 22 characters)
- `keys` (Attributes) (see [below for nested schema](#nestedatt--keys))
- `provider_type` (String) Cloud provider type (automatically set to "agent"). Default: "agent"; must be "agent"

<a id="nestedatt--keys"></a>
### Nested Schema for `keys`

## Import

Import is supported using the following syntax:

In Terraform v1.5.0 and later, the [`import` block](https://developer.hashicorp.com/terraform/language/import) can be used with the `id` attribute, for example:

```terraform
import {
  to = seqera_tower_agent_credential.my_seqera_tower_agent_credential
  id = "..."
}
```

The [`terraform import` command](https://developer.hashicorp.com/terraform/cli/commands/import) can be used, for example:

```shell
terraform import seqera_tower_agent_credential.my_seqera_tower_agent_credential "..."
```
