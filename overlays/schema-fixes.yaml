overlay: 1.0.0
x-speakeasy-jsonpath: rfc9535
info:
  title: Schema Fixes Overlay
  version: 0.0.0
actions:
  # Fix AWS Batch Config terraform-ignore (note: AwsBatchConfig uses allOf)
  - target: $["components"]["schemas"]["AwsBatchConfig"]["allOf"][1]["properties"]["forgedResources"]
    update:
      x-speakeasy-terraform-ignore: true

  # Fix discriminator mapping validation errors by removing problematic mappings
  # Note: The discriminator is on ComputeConfigUnion, not ComputeConfig
  - target: $["components"]["schemas"]["ComputeConfigUnion"]["discriminator"]["mapping"]["google-cloud"]
    remove: true
  - target: $["components"]["schemas"]["ComputeConfigUnion"]["discriminator"]["mapping"]["azure-cloud"]
    remove: true
  # Note: PlatformMetainfoUnion has the discriminator, not PlatformMetainfo
  - target: $["components"]["schemas"]["PlatformMetainfoUnion"]["discriminator"]["mapping"]["seqeracompute"]
    remove: true
  - target: $["components"]["schemas"]["PlatformMetainfoUnion"]["discriminator"]["mapping"]["google-cloud"]
    remove: true
  - target: $["components"]["schemas"]["PlatformMetainfoUnion"]["discriminator"]["mapping"]["azure-cloud"]
    remove: true

  # Update ComputeConfigUnion oneOf to remove references to deprecated schemas
  # First remove all existing oneOf items
  - target: $["components"]["schemas"]["ComputeConfigUnion"]["oneOf"][*]
    remove: true
  # Then set the new oneOf array
  - target: $["components"]["schemas"]["ComputeConfigUnion"]["oneOf"]
    update:
      - $ref: "#/components/schemas/AwsBatchConfig"
      - $ref: "#/components/schemas/AwsCloudConfig"
      - $ref: "#/components/schemas/SeqeraComputeConfig"
      - $ref: "#/components/schemas/GoogleLifeSciencesConfig"
      - $ref: "#/components/schemas/GoogleBatchConfig"
      - $ref: "#/components/schemas/AzBatchConfig"
      - $ref: "#/components/schemas/LsfComputeConfig"
      - $ref: "#/components/schemas/SlurmComputeConfig"
      - $ref: "#/components/schemas/K8sComputeConfig"
      - $ref: "#/components/schemas/EksComputeConfig"
      - $ref: "#/components/schemas/GkeComputeConfig"
      - $ref: "#/components/schemas/UnivaComputeConfig"
      - $ref: "#/components/schemas/AltairPbsComputeConfig"
      - $ref: "#/components/schemas/MoabComputeConfig"
      - $ref: "#/components/schemas/LocalComputeConfig"

  # Update PlatformMetainfoUnion oneOf references to remove deprecated schemas
  # First remove all existing oneOf items
  - target: $["components"]["schemas"]["PlatformMetainfoUnion"]["oneOf"][*]
    remove: true
  # Then set the new oneOf array
  - target: $["components"]["schemas"]["PlatformMetainfoUnion"]["oneOf"]
    update:
      - $ref: "#/components/schemas/AwsBatchPlatformMetainfo"
      - $ref: "#/components/schemas/AwsCloudPlatformMetainfo"
      - $ref: "#/components/schemas/GooglePlatformMetainfo"
      - $ref: "#/components/schemas/AzBatchPlatformMetainfo"
      - $ref: "#/components/schemas/EksPlatformMetaInfo"
      - $ref: "#/components/schemas/GkePlatformMetaInfo"
      - $ref: "#/components/schemas/K8sPlatformMetaInfo"
      - $ref: "#/components/schemas/GridPlatformMetainfo"
      - $ref: "#/components/schemas/LocalPlatformMetainfo"

  # SeqeraComputeConfig modifications (note: SeqeraComputeConfig uses allOf)
  - target: $["components"]["schemas"]["SeqeraComputeConfig"]["allOf"][1]["properties"]["region"]
    remove: true
  - target: $["components"]["schemas"]["SeqeraComputeConfig"]["allOf"][1]["properties"]["defaultDataRetentionPolicy"]
    remove: true
  - target: $["components"]["schemas"]["SeqeraComputeConfig"]
    update:
      allOf:
        - $ref: "#/components/schemas/AwsBatchConfig"

  # Remove deprecated schemas
  - target: $["components"]["schemas"]["AzCloudConfig"]
    remove: true
  - target: $["components"]["schemas"]["GoogleBucket"]
    remove: true
  - target: $["components"]["schemas"]["GoogleCloudConfig"]
    remove: true
  - target: $["components"]["schemas"]["GoogleCloudPlatformMetaInfo"]
    remove: true
  - target: $["components"]["schemas"]["GoogleImage"]
    remove: true
  - target: $["components"]["schemas"]["GoogleInstanceType"]
    remove: true
  - target: $["components"]["schemas"]["Map.Entry_String.String_"]
    remove: true
  - target: $["components"]["schemas"]["SeqeraComputePlatformDescriber"]
    remove: true
  - target: $["components"]["schemas"]["SeqeraComputePlatformMetainfo"]
    remove: true
  - target: $["components"]["schemas"]["WfFusionMeta"]
    remove: true
  - target: $["components"]["schemas"]["WfWaveMeta"]
    remove: true

  # AWS Cloud Config terraform-ignore (note: AwsCloudConfig uses allOf)
  - target: $["components"]["schemas"]["AwsCloudConfig"]["allOf"][1]["properties"]["forgedResources"]
    update:
      x-speakeasy-terraform-ignore: true

  # Launch property configuration
  - target: $["components"]["schemas"]["Launch"]["properties"]["id"]
    update:
      x-speakeasy-param-readonly: true

  # Visibility parameter configuration
  - target: $["components"]["schemas"]["Visibility"]
    update:
      x-speakeasy-param-optional: false

  # Fix regex patterns incompatible with Go RE2 engine
  # Dataset name: Replace lookahead pattern with simpler RE2-compatible pattern
  - target: $["components"]["schemas"]["Dataset"]["properties"]["name"]
    update:
      pattern: "^[a-zA-Z0-9]([a-zA-Z0-9_-]*[a-zA-Z0-9])?$"

  # Launch schemaName: Replace Unicode character class with RE2-compatible pattern
  - target: $["components"]["schemas"]["Launch"]["properties"]["schemaName"]
    update:
      pattern: "^[^/\\s][^/]*$"

  # Organization name: Replace lookahead pattern with simpler RE2-compatible pattern
  - target: $["components"]["schemas"]["Organization"]["properties"]["name"]
    update:
      pattern: "^[a-zA-Z0-9]([a-zA-Z0-9_-]*[a-zA-Z0-9])?$"

  # PipelineSecret name: Replace negative lookahead pattern with simpler RE2-compatible pattern
  - target: $["components"]["schemas"]["PipelineSecret"]["properties"]["name"]
    update:
      pattern: "^[a-zA-Z_][0-9A-Za-z_]*$"

  # Team name: Replace lookahead pattern with simpler RE2-compatible pattern
  - target: $["components"]["schemas"]["Team"]["properties"]["name"]
    update:
      pattern: "^[a-zA-Z0-9]([a-zA-Z0-9_-]*[a-zA-Z0-9])?$"

  # Workspace name: Replace lookahead pattern with simpler RE2-compatible pattern
  - target: $["components"]["schemas"]["Workspace"]["properties"]["name"]
    update:
      pattern: "^[a-zA-Z0-9]([a-zA-Z0-9_-]*[a-zA-Z0-9])?$"

  # Fix duplicate required items in CreateActionRequest (caused by multiple overlays)
  # First remove the entire required array
  - target: $["components"]["schemas"]["CreateActionRequest"]["required"]
    remove: true
  # Then add it back with correct values
  - target: $["components"]["schemas"]["CreateActionRequest"]
    update:
      required:
        - name
        - launch
