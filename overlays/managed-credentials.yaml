overlay: 1.0.0
x-speakeasy-jsonpath: rfc9535
info:
  title: Managed Credentials Overlay
  version: 0.0.0
actions:
  # Create custom Managed Credentials schema with flattened structure
  - target: $.components.schemas
    update:
      GridManagedCredentials:
        x-speakeasy-entity: ManagedCredentials
        x-speakeasy-entity-description: |
          Manage individual user SSH credentials for HPC Managed Identities.

          Managed Credentials are user-specific SSH credentials that link to a
          parent Managed Identity. Each credential contains a Linux username and
          SSH private key, enabling individual user authentication to HPC systems
          while maintaining separate user identity in system logs.

          This allows workspace users to access HPC environments with their own
          credentials rather than shared SSH keys, ensuring proper activity tracking,
          fair resource allocation through HPC queue policies, and appropriate
          access control based on individual Linux user permissions.

          Note: All users must belong to the same Linux group with access to the
          HPC work directory for proper file sharing and permissions.
        required:
          - managedIdentityId
        type: object
        properties:
          managedCredentialsId:
            type: integer
            format: int64
            description: Managed Credentials numeric identifier
            x-speakeasy-param-computed: true
            x-speakeasy-param-ordering: 1
          managedIdentityId:
            type: integer
            format: int64
            description: Parent Managed Identity numeric identifier
            x-speakeasy-param-ordering: 2
          userId:
            type: integer
            format: int64
            description: User numeric identifier
            x-speakeasy-param-ordering: 3
          userName:
            type: string
            description: Username for SSH authentication
            x-speakeasy-param-readonly: true
            x-speakeasy-param-ordering: 4
          provider:
            type: string
            enum:
              - ssh
            default: ssh
            description: Credential provider type (currently only SSH)
            example: ssh
            x-speakeasy-name-override: credentialProvider
            x-speakeasy-plan-validators: SSHCredentialValidator
            x-speakeasy-param-ordering: 5
          orgId:
            type: integer
            format: int64
            description: Organization numeric identifier
            x-speakeasy-param-ordering: 6

  # Managed Credentials entity operations
  - target: $["paths"]["/identities/{managedIdentityId}/credentials"]["post"]
    update:
      x-speakeasy-entity-operation: ManagedCredentials#create

  - target: $["paths"]["/identities/{managedIdentityId}/credentials"]["get"]
    update:
      x-speakeasy-entity-operation: ManagedCredentials#read

  - target: $["paths"]["/identities/{managedIdentityId}/credentials/{managedCredentialsId}"]["put"]
    update:
      x-speakeasy-entity-operation: ManagedCredentials#update

  - target: $["paths"]["/identities/{managedIdentityId}/credentials/{managedCredentialsId}"]["delete"]
    update:
      x-speakeasy-entity-operation: ManagedCredentials#delete

  # Parameter configurations for CREATE
  - target: $["paths"]["/identities/{managedIdentityId}/credentials"]["post"]["parameters"][?(@.name == "managedIdentityId")]
    update:
      name: managedIdentityId
      in: path
      description: Parent Managed Identity numeric identifier
      required: true
      schema:
        type: integer
        format: int64

  - target: $["paths"]["/identities/{managedIdentityId}/credentials"]["post"]["parameters"][?(@.name == "orgId")]
    update:
      name: orgId
      in: query
      description: Organization numeric identifier
      required: true
      schema:
        type: integer
        format: int64

  # Parameter configurations for LIST/READ
  - target: $["paths"]["/identities/{managedIdentityId}/credentials"]["get"]["parameters"][?(@.name == "managedIdentityId")]
    update:
      name: managedIdentityId
      in: path
      description: Parent Managed Identity numeric identifier
      required: true
      schema:
        type: integer
        format: int64

  - target: $["paths"]["/identities/{managedIdentityId}/credentials"]["get"]["parameters"][?(@.name == "orgId")]
    update:
      name: orgId
      in: query
      description: Organization numeric identifier
      required: true
      schema:
        type: integer
        format: int64

  # Update request/response schemas
  - target: $.components.schemas
    update:
      CreateGridManagedCredentialsRequest:
        type: object
        required:
          - managedCredentials
        properties:
          managedCredentials:
            $ref: '#/components/schemas/GridManagedCredentials'

      CreateGridManagedCredentialsResponse:
        type: object
        properties:
          managedCredentialsId:
            type: integer
            format: int64

      ListGridManagedCredentialsResponse:
        type: object
        properties:
          managedCredentials:
            type: array
            items:
              $ref: '#/components/schemas/GridManagedCredentials'
            x-speakeasy-param-readonly: true
          totalSize:
            type: integer
            format: int64
            x-speakeasy-param-readonly: true

      UpdateGridManagedCredentialsRequest:
        type: object
        required:
          - managedCredentials
        properties:
          managedCredentials:
            $ref: '#/components/schemas/GridManagedCredentials'

  # Update API paths to use new schemas
  - target: $["paths"]["/identities/{managedIdentityId}/credentials"]["post"]["requestBody"]["content"]["application/json"]
    update:
      schema:
        $ref: "#/components/schemas/CreateGridManagedCredentialsRequest"

  - target: $["paths"]["/identities/{managedIdentityId}/credentials"]["post"]["responses"]["200"]["content"]["application/json"]
    update:
      schema:
        $ref: "#/components/schemas/CreateGridManagedCredentialsResponse"

  - target: $["paths"]["/identities/{managedIdentityId}/credentials"]["get"]["responses"]["200"]["content"]["application/json"]
    update:
      schema:
        $ref: "#/components/schemas/ListGridManagedCredentialsResponse"

  - target: $["paths"]["/identities/{managedIdentityId}/credentials/{managedCredentialsId}"]["put"]["requestBody"]["content"]["application/json"]
    update:
      schema:
        $ref: "#/components/schemas/UpdateGridManagedCredentialsRequest"
