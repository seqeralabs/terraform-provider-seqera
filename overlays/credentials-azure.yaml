overlay: 1.0.0
x-speakeasy-jsonpath: rfc9535
info:
  title: Azure Credentials Overlay
  version: 0.0.0
actions:
  - target: $.paths
    update:
      "/credentials#azure":
        post:
          x-speakeasy-entity-operation: AzureCredential#create
          x-speakeasy-name-override: CreateAzureCredentials
          summary: Create Azure credentials
          description: Creates new Azure credentials in a user context. Append `?workspaceId`
            to create the credentials in a workspace context.
          tags:
          - credentials
          operationId: CreateAzureCredentials
          parameters:
          - name: workspaceId
            in: query
            description: Workspace numeric identifier
            schema:
              type: integer
              format: int64
          requestBody:
            description: Azure credentials create request
            content:
              application/json:
                schema:
                  $ref: "#/components/schemas/CreateAzureCredentialsRequest"
            required: true
          responses:
            "200":
              description: OK
              content:
                application/json:
                  schema:
                    $ref: "#/components/schemas/CreateAzureCredentialsResponse"
            "400":
              description: Bad request
              content:
                application/json:
                  schema:
                    $ref: "#/components/schemas/ErrorResponse"
            "403":
              description: Operation not allowed
          security:
          - BearerAuth: []

      "/credentials/{credentialsId}#azure":
        get:
          x-speakeasy-entity-operation: AzureCredential#read
          x-speakeasy-name-override: DescribeAzureCredentials
          summary: Describe Azure credentials
          description: Retrieves the details of the Azure credentials identified by the given
            `credentialsId`.
          tags:
          - credentials
          operationId: DescribeAzureCredentials
          parameters:
          - name: credentialsId
            in: path
            description: Credentials string identifier
            required: true
            schema:
              type: string
          - name: workspaceId
            in: query
            description: Workspace numeric identifier
            schema:
              type: integer
              format: int64
          responses:
            "200":
              description: OK
              content:
                application/json:
                  schema:
                    $ref: "#/components/schemas/DescribeAzureCredentialsResponse"
            "400":
              description: Bad request
              content:
                application/json:
                  schema:
                    $ref: "#/components/schemas/ErrorResponse"
            "403":
              description: Operation not allowed
            "404":
              description: Not Found - Credential does not exist or has been deleted
              content:
                application/json:
                  schema:
                    $ref: "#/components/schemas/ErrorResponse"
          security:
          - BearerAuth: []
        put:
          x-speakeasy-entity-operation: AzureCredential#update
          x-speakeasy-name-override: UpdateAzureCredentials
          summary: Update Azure credentials
          description: Updates the details of the Azure credentials identified by the given
            `credentialsId`.
          tags:
          - credentials
          operationId: UpdateAzureCredentials
          parameters:
          - name: credentialsId
            in: path
            description: Credentials string identifier
            required: true
            schema:
              type: string
          - name: workspaceId
            in: query
            description: Workspace numeric identifier
            schema:
              type: integer
              format: int64
          requestBody:
            description: Azure credentials update request
            content:
              application/json:
                schema:
                  $ref: "#/components/schemas/UpdateAzureCredentialsRequest"
            required: true
          responses:
            "204":
              description: OK - No content
            "400":
              description: Bad request
              content:
                application/json:
                  schema:
                    $ref: "#/components/schemas/ErrorResponse"
            "403":
              description: Operation not allowed
          security:
          - BearerAuth: []
        delete:
          x-speakeasy-entity-operation: AzureCredential#delete
          x-speakeasy-name-override: DeleteAzureCredentials
          summary: Delete Azure credentials
          description: Deletes the Azure credentials identified by the given `credentialsId`.
          tags:
          - credentials
          operationId: DeleteAzureCredentials
          parameters:
          - name: credentialsId
            in: path
            description: Credentials string identifier
            required: true
            schema:
              type: string
          - name: workspaceId
            in: query
            description: Workspace numeric identifier
            schema:
              type: integer
              format: int64
          - name: checked
            in: query
            description: If set credentials deletion will be blocked by running jobs that
              depend on them
            schema:
              type: boolean
          responses:
            "204":
              description: OK - No content
            "400":
              description: Bad request
              content:
                application/json:
                  schema:
                    $ref: "#/components/schemas/ErrorResponse"
            "403":
              description: Operation not allowed
            "409":
              description: Running jobs block the deletion of this credentials
              content:
                application/json:
                  schema:
                    $ref: "#/components/schemas/DeleteCredentialsConflictResponse"
          security:
          - BearerAuth: []

  - target: $.components.schemas
    update:
      # Azure-specific credential schema with flattened keys
      AzureCredential:
        required:
          - name
          - keys
        type: object
        properties:
          id:
            type: string
            description: Unique identifier for the credential (max 22 characters)
            x-speakeasy-name-override: credentialsId
            x-speakeasy-param-readonly: true
            x-speakeasy-param-suppress-computed-diff: true
          name:
            maxLength: 100
            type: string
            description: Display name for the credential (max 100 characters)
            x-speakeasy-param-force-new: true
          provider:
            type: string
            enum: [azure]
            default: azure
            description: Cloud provider type (automatically set to "azure")
            x-speakeasy-name-override: providerType
            x-speakeasy-param-readonly: true
          deleted:
            type: boolean
            description: Flag indicating if the credential has been soft-deleted
            x-speakeasy-param-readonly: true
            x-speakeasy-terraform-ignore: true
          lastUsed:
            type: string
            format: date-time
            description: Timestamp when the credential was last used
            x-speakeasy-param-readonly: true
            x-speakeasy-terraform-ignore: true
          dateCreated:
            type: string
            format: date-time
            description: Timestamp when the credential was created
            x-speakeasy-param-readonly: true
            x-speakeasy-terraform-ignore: true
          lastUpdated:
            type: string
            format: date-time
            description: Timestamp when the credential was last updated
            x-speakeasy-param-readonly: true
            x-speakeasy-terraform-ignore: true
          keys:
            x-speakeasy-entity: AzureCredential
            x-speakeasy-entity-description: |
              Manage Azure credentials in Seqera platform using this resource.

              Azure credentials support three authentication modes:
              - Shared key: Use batch_key and storage_key (discriminator='azure')
              - Entra: Use tenant_id, client_id, client_secret (discriminator='azure-entra')
              - Cloud: Use tenant_id, client_id, client_secret (discriminator='azure-cloud')
            type: object
            required:
              - batchName
              - storageName
            properties:
              discriminator:
                type: string
                description: Authentication mode discriminator (azure, azure-entra, or azure-cloud)
                enum: [azure, azure-entra, azure-cloud]
                default: azure
                x-speakeasy-terraform-ignore: true
                x-speakeasy-param-readonly: true
              batchName:
                type: string
                description: Azure Batch account name (required)
                example: "myazurebatch"
                x-speakeasy-param-computed: false
                x-speakeasy-name-override: batch_name
              storageName:
                type: string
                description: Azure Blob Storage account name (required)
                example: "myazurestorage"
                x-speakeasy-param-computed: false
                x-speakeasy-name-override: storage_name
              batchKey:
                type: string
                description: Azure Batch account key (for shared key authentication)
                x-speakeasy-param-sensitive: true
                x-speakeasy-param-computed: false
                example: "YourAzureBatchAccountKeyHere=="
                x-speakeasy-name-override: batch_key
                x-speakeasy-plan-validators: AzureCredentialSharedKeyValidator
              storageKey:
                type: string
                description: Azure Storage account key (for shared key authentication)
                x-speakeasy-param-sensitive: true
                x-speakeasy-param-computed: false
                example: "YourAzureStorageAccountKeyHere=="
                x-speakeasy-name-override: storage_key
                x-speakeasy-plan-validators: AzureCredentialSharedKeyValidator
              tenantId:
                type: string
                description: Azure tenant ID (for Entra/Cloud authentication)
                example: "00000000-0000-0000-0000-000000000000"
                x-speakeasy-param-computed: false
                x-speakeasy-name-override: tenant_id
                x-speakeasy-plan-validators: AzureCredentialEntraValidator
              clientId:
                type: string
                description: Azure service principal client ID (for Entra/Cloud authentication)
                example: "00000000-0000-0000-0000-000000000000"
                x-speakeasy-param-computed: false
                x-speakeasy-name-override: client_id
                x-speakeasy-plan-validators: AzureCredentialEntraValidator
              clientSecret:
                type: string
                description: Azure service principal client secret (for Entra/Cloud authentication)
                x-speakeasy-param-sensitive: true
                x-speakeasy-param-computed: false
                example: "YourAzureClientSecretHere"
                x-speakeasy-name-override: client_secret
                x-speakeasy-plan-validators: AzureCredentialEntraValidator

      # Azure-specific request/response schemas
      CreateAzureCredentialsRequest:
        type: object
        required:
          - credentials
        properties:
          credentials:
            $ref: '#/components/schemas/AzureCredential'

      CreateAzureCredentialsResponse:
        type: object
        properties:
          credentialsId:
            type: string

      UpdateAzureCredentialsRequest:
        type: object
        required:
          - credentials
        properties:
          credentials:
            $ref: '#/components/schemas/AzureCredential'

      DescribeAzureCredentialsResponse:
        type: object
        properties:
          credentials:
            $ref: '#/components/schemas/AzureCredential'

  # ============================================================================
  # CLEANUP - Remove unused fields
  # ============================================================================

  # Remove description field (not used in web UI)
  - target: $.components.schemas.AzureCredential.properties.description
    remove: true

  # Remove baseUrl field (not used in web UI)
  - target: $.components.schemas.AzureCredential.properties.baseUrl
    remove: true

  # Remove category field (not used in web UI)
  - target: $.components.schemas.AzureCredential.properties.category
    remove: true

  # Remove checked parameter from delete operation (not used in web UI)
  - target: $["paths"]["/credentials/{credentialsId}#azure"]["delete"]["parameters"][?(@.name == "checked")]
    remove: true

  # ============================================================================
  # SECURITY - Add writeOnly properties to sensitive fields
  # ============================================================================

  # Mark batchKey as writeOnly (never returned in API responses)
  - target: $.components.schemas.AzureCredential.properties.keys.properties.batchKey
    update:
      writeOnly: true

  # Mark storageKey as writeOnly (never returned in API responses)
  - target: $.components.schemas.AzureCredential.properties.keys.properties.storageKey
    update:
      writeOnly: true

  # Mark tenantId as writeOnly (never returned in API responses)
  - target: $.components.schemas.AzureCredential.properties.keys.properties.tenantId
    update:
      writeOnly: true

  # Mark clientId as writeOnly (never returned in API responses)
  - target: $.components.schemas.AzureCredential.properties.keys.properties.clientId
    update:
      writeOnly: true

  # Mark clientSecret as writeOnly (never returned in API responses)
  - target: $.components.schemas.AzureCredential.properties.keys.properties.clientSecret
    update:
      writeOnly: true
