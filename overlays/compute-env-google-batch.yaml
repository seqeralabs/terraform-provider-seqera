overlay: 1.0.0
x-speakeasy-jsonpath: rfc9535
info:
  title: Google Batch Compute Environment Overlay
  version: 1.0.0

# ==============================================================================
# GOOGLE BATCH COMPUTE ENVIRONMENT RESOURCE OVERLAY
# ==============================================================================
#
# This overlay enhances the Google Batch-specific compute environment resource
# with improved descriptions, validators, and Terraform-friendly naming.
#
# TERRAFORM EXAMPLES:
# -------------------
#
# Example 1: Basic Google Batch configuration
# resource "seqera_google_batch_ce" "basic" {
#   name           = "google-batch-basic"
#   workspace_id   = 123
#   credentials_id = seqera_gcp_credential.main.credentials_id
#   # platform defaults to "google-batch" - no need to specify
#
#   config = {
#     location = "us-central1"
#     work_dir = "gs://my-bucket/work"
#   }
# }
#
# Example 2: Google Batch with Spot instances and Fusion
# resource "seqera_google_batch_ce" "spot" {
#   name           = "google-batch-spot"
#   workspace_id   = 123
#   credentials_id = seqera_gcp_credential.main.credentials_id
#   # platform defaults to "google-batch" - no need to specify
#
#   config = {
#     location          = "us-central1"
#     work_dir          = "gs://my-bucket/work"
#     enable_fusion     = true
#     enable_wave       = true
#     spot              = true
#     boot_disk_size_gb = 200
#
#     labels = {
#       environment = "production"
#       team        = "data-science"
#     }
#   }
# }
#
# ==============================================================================

actions:
  - target: $.paths
    update:
      "/compute-envs#google-batch":
        post:
          x-speakeasy-entity-operation:
            terraform-datasource: null
            terraform-resource: GoogleBatchCE#create
          x-speakeasy-name-override: CreateGoogleBatchCE
          summary: Create Google Batch compute environment
          description: Creates a new Google Batch compute environment. Append `?workspaceId` to create the environment in a workspace context.
          x-speakeasy-retries:
            strategy: backoff
            backoff:
              initialInterval: 5000
              maxInterval: 5000
              maxElapsedTime: 30000
              exponent: 1.0
            statusCodes:
              - 429
              - 500
              - 502
              - 503
              - 504
          tags:
            - compute-envs
          operationId: CreateGoogleBatchCE
          parameters:
            - name: workspaceId
              in: query
              description: Workspace numeric identifier
              schema:
                type: integer
                format: int64
              required: true
          requestBody:
            description: Google Batch compute environment create request
            content:
              application/json:
                schema:
                  $ref: "#/components/schemas/CreateGoogleBatchCERequest"
            required: true
          responses:
            "200":
              description: OK
              content:
                application/json:
                  schema:
                    $ref: "#/components/schemas/CreateGoogleBatchCEResponse"
            "400":
              description: Bad request
              content:
                application/json:
                  schema:
                    $ref: "#/components/schemas/ErrorResponse"
            "403":
              description: Operation not allowed
            "409":
              description: Conflict - resource already exists
              content:
                application/json:
                  schema:
                    $ref: "#/components/schemas/ErrorResponse"
          security:
            - BearerAuth: []

      "/compute-envs/{computeEnvId}#google-batch":
        get:
          x-speakeasy-entity-operation:
            terraform-datasource: null
            terraform-resource: GoogleBatchCE#read
          x-speakeasy-name-override: DescribeGoogleBatchCE
          summary: Describe Google Batch compute environment
          description: Retrieves the details of the Google Batch compute environment identified by the given `computeEnvId`.
          tags:
            - compute-envs
          operationId: DescribeGoogleBatchCE
          parameters:
            - name: computeEnvId
              in: path
              description: Compute environment string identifier
              required: true
              schema:
                type: string
            - name: workspaceId
              in: query
              description: Workspace numeric identifier
              schema:
                type: integer
                format: int64
              required: true
            - name: attributes
              in: query
              description: "Additional attribute values to include in the response (`labels`). Returns an empty value (`labels: null`) if omitted."
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/ComputeEnvQueryAttribute"
          responses:
            "200":
              description: OK
              content:
                application/json:
                  schema:
                    $ref: "#/components/schemas/DescribeGoogleBatchCEResponse"
            "400":
              description: Bad request
              content:
                application/json:
                  schema:
                    $ref: "#/components/schemas/ErrorResponse"
            "403":
              description: Operation not allowed
            "404":
              description: Compute environment not found
              content:
                application/json:
                  schema:
                    $ref: "#/components/schemas/ErrorResponse"
          security:
            - BearerAuth: []
        delete:
          x-speakeasy-entity-operation:
            terraform-datasource: null
            terraform-resource: GoogleBatchCE#delete
          x-speakeasy-name-override: DeleteGoogleBatchCE
          summary: Delete Google Batch compute environment
          description: Deletes the Google Batch compute environment identified by the given `computeEnvId`.
          tags:
            - compute-envs
          operationId: DeleteGoogleBatchCE
          parameters:
            - name: computeEnvId
              in: path
              description: Compute environment string identifier
              required: true
              schema:
                type: string
            - name: workspaceId
              in: query
              description: Workspace numeric identifier
              schema:
                type: integer
                format: int64
          responses:
            "204":
              description: OK - No content
            "400":
              description: Bad request
              content:
                application/json:
                  schema:
                    $ref: "#/components/schemas/ErrorResponse"
            "403":
              description: Operation not allowed
          security:
            - BearerAuth: []

  - target: $.components.schemas
    update:
      # Google Batch-specific compute environment schema
      GoogleBatchCE_ComputeConfig:
        x-speakeasy-entity: GoogleBatchCE
        x-speakeasy-entity-version: 1
        x-speakeasy-entity-description: |
          Manage Google Batch compute environments in Seqera platform using this resource.

          Google Batch compute environments define the execution platform where a pipeline will run
          on Google Cloud infrastructure using the Google Batch service.
        required:
          - config
          - name
          - platform
          - credentialsId
        type: object
        properties:
          credentialsId:
            type: string
            description: Google Cloud credentials identifier
          orgId:
            type: integer
            format: int64
            readOnly: true
            x-speakeasy-param-readonly: true
          workspaceId:
            type: integer
            format: int64
            description: Workspace numeric identifier
          id:
            type: string
            description: Unique identifier for the compute environment
            x-speakeasy-param-readonly: true
          name:
            maxLength: 100
            type: string
            pattern: '^[a-zA-Z0-9_-]+$'
            description: A unique name for this compute environment. Use only alphanumeric, dash, and underscore characters.
            x-speakeasy-param-force-new: true
            x-speakeasy-plan-validators: ComputeEnvNameValidator
          description:
            type: string
            description: Optional description of the compute environment
            x-speakeasy-param-computed: false
          platform:
            type: string
            enum:
              - google-batch
            default: google-batch
            description: Google Cloud platform type (defaults to google-batch)
          status:
            type: string
            description: Compute environment status
            x-speakeasy-param-readonly: true
          dateCreated:
            type: string
            format: date-time
            description: Timestamp when the compute environment was created
            x-speakeasy-param-readonly: true
          lastUpdated:
            type: string
            format: date-time
            description: Timestamp when the compute environment was last updated
            x-speakeasy-param-readonly: true
          lastUsed:
            type: string
            format: date-time
            description: Timestamp when the compute environment was last used
            x-speakeasy-param-readonly: true
          deleted:
            type: boolean
            description: Flag indicating if the compute environment has been deleted
            x-speakeasy-param-readonly: true
          config:
            description: Google Batch-specific compute environment configuration
            $ref: '#/components/schemas/GoogleBatchConfig'

      # Google Batch-specific request/response schemas
      CreateGoogleBatchCERequest:
        type: object
        properties:
          computeEnv:
            $ref: '#/components/schemas/GoogleBatchCE_ComputeConfig'
          labelIds:
            type: array
            items:
              type: integer
              format: int64

      CreateGoogleBatchCEResponse:
        type: object
        properties:
          computeEnvId:
            type: string

      UpdateGoogleBatchCERequest:
        type: object
        properties:
          computeEnv:
            $ref: '#/components/schemas/GoogleBatchCE_ComputeConfig'

      DescribeGoogleBatchCEResponse:
        type: object
        properties:
          computeEnv:
            $ref: '#/components/schemas/GoogleBatchCE_ComputeConfig'

      ListGoogleBatchCEsResponse:
        type: object
        properties:
          computeEnvs:
            type: array
            items:
              $ref: '#/components/schemas/GoogleBatchCE_ComputeConfig'
          totalSize:
            type: integer
            format: int64

  # ============================================================================
  # REMOVE INTERNAL/DEBUG FIELDS NOT EXPOSED IN UI
  # ============================================================================

  # Remove SSH daemon configuration (debugging feature not exposed in UI)
  - target: $.components.schemas.GoogleBatchConfig.properties.sshDaemon
    remove: true

  - target: $.components.schemas.GoogleBatchConfig.properties.sshImage
    remove: true

  # Remove debug mode (internal debugging feature)
  - target: $.components.schemas.GoogleBatchConfig.properties.debugMode
    remove: true

  # Remove copy image (internal feature not exposed in UI)
  - target: $.components.schemas.GoogleBatchConfig.properties.copyImage
    remove: true

  # Remove NFS configuration (not exposed in UI - advanced storage feature)
  - target: $.components.schemas.GoogleBatchConfig.properties.nfsTarget
    remove: true

  - target: $.components.schemas.GoogleBatchConfig.properties.nfsMount
    remove: true

  # Remove machine type and CPU platform (auto-selected by Seqera)
  - target: $.components.schemas.GoogleBatchConfig.properties.machineType
    remove: true

  - target: $.components.schemas.GoogleBatchConfig.properties.cpuPlatform
    remove: true

  # Remove project ID (derived from credentials)
  - target: $.components.schemas.GoogleBatchConfig.properties.projectId
    remove: true

  # ============================================================================
  # FIELD DESCRIPTIONS AND VALIDATORS
  # ============================================================================

  # Make top-level Google Batch Compute Environment fields force replacement
  # NOTE: name field does NOT have force-new - it can be updated in-place
  - target: $.components.schemas.GoogleBatchCE_ComputeConfig.properties.description
    update:
      x-speakeasy-param-force-new: true
  - target: $.components.schemas.GoogleBatchCE_ComputeConfig.properties.platform
    update:
      x-speakeasy-param-force-new: true
  - target: $.components.schemas.GoogleBatchCE_ComputeConfig.properties.credentialsId
    update:
      x-speakeasy-param-force-new: true
  - target: $.components.schemas.GoogleBatchCE_ComputeConfig.properties.workspaceId
    update:
      x-speakeasy-param-force-new: true
  - target: $.components.schemas.GoogleBatchCE_ComputeConfig.properties.config
    update:
      x-speakeasy-param-force-new: true

  # Add descriptions to GoogleBatchConfig fields
  - target: $.components.schemas.GoogleBatchConfig.properties.location
    update:
      description: |
        Google Cloud region where the Batch compute environment will be created.
        Examples: us-central1, us-east1, europe-west1, asia-southeast1
      example: "us-central1"
      x-speakeasy-param-force-new: true
      x-speakeasy-param-optional: false

  - target: $.components.schemas.GoogleBatchConfig.properties.workDir
    update:
      description: |
        Google Cloud Storage bucket path for Nextflow work directory where intermediate files will be stored.
        Format: gs://bucket-name/path
      example: "gs://my-nextflow-bucket/work"
      pattern: "^gs://.+"
      x-speakeasy-param-force-new: true
      x-speakeasy-param-optional: false

  - target: $.components.schemas.GoogleBatchConfig.properties.spot
    update:
      description: |
        Enable Spot (preemptible) VM instances for compute jobs.
        Spot instances are cost-effective but can be interrupted by Google Cloud.
        Set to true to use Spot instances, false for standard instances.
      example: true
      x-speakeasy-param-force-new: true

  - target: $.components.schemas.GoogleBatchConfig.properties.bootDiskSizeGb
    update:
      description: |
        Size of the boot disk in GB for compute instances.
        Minimum size depends on the base image used.
      example: 50
      x-speakeasy-param-force-new: true

  - target: $.components.schemas.GoogleBatchConfig.properties.preRunScript
    update:
      description: |
        Bash script to run before workflow execution begins.
        Use for environment setup, loading modules, downloading reference data, etc.
      x-speakeasy-param-force-new: true

  - target: $.components.schemas.GoogleBatchConfig.properties.postRunScript
    update:
      description: |
        Bash script to run after workflow execution completes.
        Use for cleanup, archiving results, sending notifications, etc.
      x-speakeasy-param-force-new: true

  - target: $.components.schemas.GoogleBatchConfig.properties.headJobCpus
    update:
      description: "Number of CPUs allocated for the head job (default: 1)"
      example: 4
      x-speakeasy-param-force-new: true

  - target: $.components.schemas.GoogleBatchConfig.properties.headJobMemoryMb
    update:
      description: "Memory allocation for the head job in MB (default: 1024)"
      example: 8192
      x-speakeasy-param-force-new: true

  - target: $.components.schemas.GoogleBatchConfig.properties.serviceAccount
    update:
      description: |
        Service account email to use for compute jobs.
        This service account needs appropriate IAM permissions for GCS, logging, etc.
        Format: service-account-name@project-id.iam.gserviceaccount.com
      example: "nextflow-sa@my-project.iam.gserviceaccount.com"
      x-speakeasy-param-force-new: true

  - target: $.components.schemas.GoogleBatchConfig.properties.network
    update:
      description: |
        VPC network name or URL for compute instances.
        Format: projects/PROJECT_ID/global/networks/NETWORK_NAME
        Or simply: NETWORK_NAME (for networks in the same project)
      example: "projects/my-project/global/networks/default"
      x-speakeasy-param-force-new: true

  - target: $.components.schemas.GoogleBatchConfig.properties.subnetwork
    update:
      description: |
        VPC subnetwork name or URL for compute instances.
        Must be in the same region as the compute environment.
        Format: projects/PROJECT_ID/regions/REGION/subnetworks/SUBNETWORK_NAME
        Or simply: SUBNETWORK_NAME
      example: "projects/my-project/regions/us-central1/subnetworks/default"
      x-speakeasy-param-force-new: true

  - target: $.components.schemas.GoogleBatchConfig.properties.usePrivateAddress
    update:
      description: |
        Use only internal IP addresses for compute instances (no external IP).
        Requires Cloud NAT or Private Google Access to be configured.
        Set to true for enhanced security and to avoid external IP quotas.
      example: false
      x-speakeasy-param-force-new: true

  - target: $.components.schemas.GoogleBatchConfig.properties.labels
    update:
      description: |
        Key-value labels to apply to compute resources.
        Use for resource organization, cost tracking, and filtering.
      example:
        environment: production
        team: data-science
      x-speakeasy-param-force-new: true

  - target: $.components.schemas.GoogleBatchConfig.properties.headJobInstanceTemplate
    update:
      description: |
        Custom instance template name for head job.
        Allows advanced configuration of head job compute resources.
      x-speakeasy-param-force-new: true

  - target: $.components.schemas.GoogleBatchConfig.properties.computeJobsInstanceTemplate
    update:
      description: |
        Custom instance template name for compute jobs.
        Allows advanced configuration of worker compute resources.
      x-speakeasy-param-force-new: true
