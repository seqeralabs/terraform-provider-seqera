locals {
  work_dir = "gs://terraform-provider-testing"
}

## Organizations
resource "seqera_orgs" "test_org" {
  description = "testing org for the terraform provider - GCP"
  full_name   = "seqera_test_shahbaz_tf_provider_gcp"
  name        = "seqera_test_shahbaz_tf_provider_gcp"
}

## Workspaces
resource  "seqera_workspace" "my_workspace" {
  description = "A test workspace created with Terraform for GCP"
  name        = "test-workspace-tf-gcp"
  full_name   = "Test Workspace for Terraform Provider"
  org_id     = resource.seqera_orgs.test_org.org_id
  visibility = "PRIVATE"
}

## Datasets
resource "seqera_datasets" "my_datasets" {
  description  = "Terraform created dataset"
  name         = "terraform-dataset"
  workspace_id = resource.seqera_workspace.my_workspace.id
}

locals {
  service_account_key = file("${path.module}/service-account-key.json")
}

## Credentials
resource "seqera_credential" "gcp_credential" {

  name          = "test_credential"
  provider_type = "google"
  workspace_id  = resource.seqera_workspace.my_workspace.id
  description   = "AWS credentials generated by terraform"    
  keys = {
    google = {
        data = local.service_account_key
    }
      
  }
  
}


resource "seqera_compute_env" "gcp_batch_compute_env" {
  workspace_id = resource.seqera_workspace.my_workspace.id
  
  compute_env = {
    name         = "gcp-batch-compute-env"
    description  = "GCP Batch compute environment for bioinformatics workflows"
    platform     = "google-batch"
    credentials_id = resource.seqera_credential.gcp_credential.credentials_id
    
    config = {
      google_batch = {
        region           = "us-central1" 
        work_dir         = local.work_dir
        # machine_type     = "e2-standard-4"
        location        = "us-central1"
      }
    }
  }
}

resource "seqera_pipeline" "hello_world_minimal" {
  description = "Hello world pipeline generated by terraform"
  name                 = "terraform-hello-world-1"
  launch = {
    compute_env_id = resource.seqera_compute_env.gcp_batch_compute_env.compute_env_id
    config_profiles = []
    head_job_cpus      = 6
    # head_job_memory_mb = 32
    pipeline             = "https://github.com/nextflow-io/hello"
    pull_latest          = true
    resume               = false
    revision             = "master"
    work_dir = local.work_dir
  }
  workspace_id = resource.seqera_workspace.my_workspace.id
}



## Launch a workflow
resource "seqera_workflows" "my_workflows" {
  compute_env_id = resource.seqera_compute_env.gcp_batch_compute_env.compute_env_id
  pipeline     = "nextflow-io/hello"
  work_dir     = local.work_dir
  workspace_id = resource.seqera_workspace.my_workspace.id
  depends_on = [ seqera_compute_env.gcp_batch_compute_env]
}

