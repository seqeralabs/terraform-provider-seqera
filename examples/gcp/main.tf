resource "seqera_orgs" "my_org" {
  description = "Example org for running GCP centric workflows"
  full_name   = "gcp-example-org"
  name        = "gcp-example-org"
}

resource "seqera_workspace" "my_workspace" {
  description = "An example gcp workspace created with Terraform"
  name        = "example-workspace-gcp"
  full_name   = "Example GCP Workspace"
  org_id      = resource.seqera_orgs.my_org.org_id
  visibility  = "PRIVATE"
}

resource "seqera_datasets" "my_datasets" {
  description  = "Example dataset"
  name         = "terraform-dataset"
  workspace_id = resource.seqera_workspace.my_workspace.id
}

resource "seqera_pipeline_secret" "my_pipelinesecret" {
  name         = "example_terraform_secret"
  value        = "SECRET_VALUE"
  workspace_id = resource.seqera_workspace.my_workspace.id
}

resource "seqera_credential" "gcp_credential" {
  name          = "gcp-terraform-credential"
  provider_type = "google"
  workspace_id  = resource.seqera_workspace.my_workspace.id
  description   = "GCP credentials generated by Terraform"
  keys = {
    google = {
      data = file("${var.service_account_key}")
    }
  }
}

resource "seqera_compute_env" "gcp_batch_compute_env" {
  workspace_id = resource.seqera_workspace.my_workspace.id

  compute_env = {
    name           = "gcp-batch-compute-env"
    description    = "GCP Batch compute environment for bioinformatics workflows"
    platform       = "google-batch"
    credentials_id = resource.seqera_credential.gcp_credential.credentials_id

    config = {
      google_batch = {
        region   = var.gcp_region
        work_dir = var.work_dir
        location = var.gcp_location

        machine_type = "n2-standard-8"  # 8 vCPUs, 32GB RAM

        head_job_cpus      = 4
        head_job_memory_mb = 16384

        fusion2_enabled = true
        wave_enabled    = true

        spot = true

        boot_disk_size_gb = 100

        pre_run_script  = file("${path.module}/scripts/pre-run.sh")
        post_run_script = file("${path.module}/scripts/post-run.sh")
      }
    }
  }
}

resource "seqera_pipeline" "rnaseq_pipeline" {
  description = "RNA-seq analysis pipeline using nf-core/rnaseq"
  name        = "rna-seq"
  icon        = "https://avatars.githubusercontent.com/u/35520196?v=4"
  label_ids   = [resource.seqera_labels.my_labels.label_id]
  launch = {
    compute_env_id      = resource.seqera_compute_env.gcp_batch_compute_env.compute_env_id
    config_profiles     = ["test"]
    pipeline            = "https://github.com/nf-core/rnaseq"
    revision            = "3.19.0"
    work_dir            = var.work_dir
    params_text         = "{\"outdir\": \"${var.work_dir}\"}"
    pull_latest         = false
    stub_run            = false
    workspace_secrets   = [resource.seqera_pipeline_secret.my_pipelinesecret.name]
    pre_run_script      = file("${path.module}/scripts/pre-run.sh")
    post_run_script     = file("${path.module}/scripts/post-run.sh")
  }
  workspace_id = resource.seqera_workspace.my_workspace.id
}

resource "seqera_workflows" "rnaseq_workflow" {
  compute_env_id      = resource.seqera_compute_env.gcp_batch_compute_env.compute_env_id
  pipeline            = "nf-core/rnaseq"
  revision            = "3.19.0"
  work_dir            = var.work_dir
  workspace_id        = resource.seqera_workspace.my_workspace.id
  config_profiles     = ["test"]
  params_text         = "{\"outdir\": \"${var.work_dir}\"}"
  pull_latest         = false
  stub_run            = false
  label_ids           = [resource.seqera_labels.my_labels.label_id]
  workspace_secrets   = [resource.seqera_pipeline_secret.my_pipelinesecret.name]
  pre_run_script      = file("${path.module}/scripts/pre-run.sh")
  post_run_script     = file("${path.module}/scripts/post-run.sh")
  depends_on          = [seqera_compute_env.gcp_batch_compute_env]
}

# Resource Labels
resource "seqera_labels" "my_labels" {
  is_default   = false
  name         = "terraform-example-label"
  resource     = true
  value        = "terraform-label-value"
  workspace_id = resource.seqera_workspace.my_workspace.id
}