resource "seqera_orgs" "my_org" {
  description = "Example org for running Azure centric workflows"
  full_name   = "azure-example-org"
  name        = "azure-example-org"
}

resource "seqera_workspace" "my_workspace" {
  description = "An example azure workspace created with Terraform"
  name        = "example-workspace-azure"
  full_name   = "Example Workspace "
  org_id      = resource.seqera_orgs.my_org.org_id
  visibility  = "PRIVATE"
}

resource "seqera_datasets" "my_datasets" {
  description  = "Example dataset"
  name         = "terraform-dataset"
  workspace_id = resource.seqera_workspace.my_workspace.id
}


resource "seqera_credential" "azure_credential" {
  name          = "azure-terraform-credential"
  provider_type = "azure"
  workspace_id  = resource.seqera_workspace.my_workspace.id
  description   = "Azure credentials generated by Terraform"
  keys = {
    azure = {
      batch_key    = var.batch_key
      batch_name   = var.batch_name
      storage_key  = var.storage_key
      storage_name = var.storage_name
    }
  }
}

resource "seqera_compute_env" "azure_batch_compute_env" {
  workspace_id = resource.seqera_workspace.my_workspace.id

  compute_env = {
    name           = "azure-batch-compute-env"
    description    = "Azure Batch compute environment for bioinformatics workflows"
    platform       = "azure-batch"
    credentials_id = resource.seqera_credential.azure_credential.credentials_id

    config = {
      azure_batch = {
        region   = var.azure_region
        work_dir = var.work_dir

        forge = {
          vm_count = 1
        }
      }
    }
  }
}

resource "seqera_pipeline" "hello_world_minimal" {
  description = "Hello world pipeline generated by Terraform"
  name        = "terraform-hello-world-azure"
  launch = {
    compute_env_id  = resource.seqera_compute_env.azure_batch_compute_env.compute_env_id
    config_profiles = []
    head_job_cpus   = 6
    pipeline        = "https://github.com/nextflow-io/hello"
    pull_latest     = true
    resume          = false
    revision        = "master"
    work_dir        = var.work_dir
  }
  workspace_id = resource.seqera_workspace.my_workspace.id
}

resource "seqera_workflows" "my_workflows" {
  compute_env_id = resource.seqera_compute_env.azure_batch_compute_env.compute_env_id
  pipeline       = "nextflow-io/hello"
  work_dir       = var.work_dir
  workspace_id   = resource.seqera_workspace.my_workspace.id
  depends_on     = [seqera_compute_env.azure_batch_compute_env]
}